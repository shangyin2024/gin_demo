# 定时任务功能 - 新增特性

> 日期: 2026-01-13  
> 版本: v2.2

---

## ✅ 新增功能

### 🎯 核心能力

1. **Cron 任务调度**
   - ✅ 秒级精度
   - ✅ 标准 Cron 表达式
   - ✅ 时区支持

2. **Redis 分布式锁**
   - ✅ 防止重复执行
   - ✅ 多实例安全
   - ✅ 自动过期

3. **任务管理**
   - ✅ 简单的任务接口
   - ✅ 超时控制
   - ✅ 错误处理

---

## 📁 新增文件

```
pkg/task/
├── scheduler.go        # ⭐ 任务调度器核心
└── base.go            # ⭐ 基础任务类

internal/task/
├── manager.go         # ⭐ 任务管理器
└── tasks/             # ⭐ 具体任务
    ├── example_task.go
    ├── cleanup_task.go
    └── stats_task.go

docs/
├── TASK_SCHEDULER.md  # ⭐ 完整文档 (5000+ 字)
└── TASK_FEATURE.md    # ⭐ 功能说明
```

---

## 🚀 快速使用

### 1. 创建任务

```go
type MyTask struct{}

func (t *MyTask) Name() string {
    return "my_task"
}

func (t *MyTask) Spec() string {
    return "0 */5 * * * *" // 每 5 分钟
}

func (t *MyTask) Timeout() time.Duration {
    return 2 * time.Minute
}

func (t *MyTask) Run(ctx context.Context) error {
    // 任务逻辑
    return nil
}
```

### 2. 注册任务

在 `internal/task/manager.go` 中：

```go
scheduler.Register(tasks.NewMyTask())
```

### 3. 自动启动

应用启动时会自动启动任务调度器。

---

## 📊 内置任务

| 任务 | 频率 | 说明 |
|------|------|------|
| **ExampleTask** | 每分钟 | 示例任务 |
| **CleanupTask** | 每天 2:00 | 清理过期数据 |
| **StatsTask** | 每小时 | 统计数据 |

---

## 🔒 分布式锁原理

```
┌─────────┐         ┌─────────┐         ┌─────────┐
│ 实例 A  │         │  Redis  │         │ 实例 B  │
└────┬────┘         └────┬────┘         └────┬────┘
     │                   │                    │
     ├─ 尝试获取锁 ───►  │                    │
     │  SET NX          │                    │
     │                   ├─ 返回 true ─────► │
     │                   │                    │
     ├─ 执行任务 ────►   │                    │
     │                   │   ◄─ 尝试获取锁 ──┤
     │                   ├─ 返回 false ───────┤
     │                   │   (已被占用)       │
     │                   │                    │
     ├─ 释放锁 ─────────►│                    │
```

**关键**: 
- 使用 `SET NX EX` 原子操作
- 自动过期防止死锁
- defer 确保释放

---

## 📈 性能影响

| 指标 | 影响 |
|------|------|
| **内存** | +5-10MB |
| **CPU** | 可忽略 |
| **Redis** | 每次执行 2 次操作 |

**结论**: 性能开销极小 ✅

---

## 🎓 Cron 表达式速查

```
┌─ 秒 (0-59)
│ ┌─ 分 (0-59)
│ │ ┌─ 时 (0-23)
│ │ │ ┌─ 日 (1-31)
│ │ │ │ ┌─ 月 (1-12)
│ │ │ │ │ ┌─ 周 (0-6)
* * * * * *
```

**常用示例**:
- `0 * * * * *` - 每分钟
- `0 0 * * * *` - 每小时
- `0 0 2 * * *` - 每天 2:00
- `0 0 0 * * 0` - 每周日 0:00

---

## 📚 相关文档

- [定时任务完整指南](./TASK_SCHEDULER.md) - 详细文档
- [pkg/task 使用说明](../pkg/task/README.md) - API 文档

---

## 🎯 适用场景

✅ 数据清理  
✅ 统计计算  
✅ 数据同步  
✅ 报表生成  
✅ 缓存预热  
✅ 定期备份  

---

## 🚨 注意事项

1. **幂等性** - 任务应可重复执行
2. **超时** - 设置合理超时时间
3. **错误处理** - 任务失败会记录日志
4. **分布式** - Redis 锁保证多实例安全

---

**企业级定时任务系统，开箱即用！** ⏰
